# Система Скилов и Атрибутов MMORPG

## Обзор

Эта система реализует комплексную систему скилов и атрибутов для MMORPG, интегрированную с существующей боевой системой.

## Архитектура

### Структуры данных

#### SkillStruct
Основная структура для скила:
```cpp
struct SkillStruct {
    std::string skillName;          // Название скила
    std::string skillSlug;          // Slug скила для идентификации
    std::string scaleStat;          // Атрибут для масштабирования урона
    std::string school;             // Школа магии (physical, fire, ice, etc.)
    std::string skillEffectType;    // Тип эффекта (damage, heal, buff, etc.)
    int skillLevel;                 // Уровень скила
    float coeff;                    // Коэффициент масштабирования
    float flatAdd;                  // Плоская добавка к урону
    int cooldownMs;                 // Время восстановления в мс
    int gcdMs;                      // Глобальный КД в мс
    int castMs;                     // Время каста в мс
    int costMp;                     // Стоимость маны
    float maxRange;                 // Максимальная дальность
};
```

#### EntityAttributeStruct
Структура для атрибутов персонажей и мобов:
```cpp
struct EntityAttributeStruct {
    int id;
    std::string name;
    std::string slug;              // Для быстрого поиска
    int value;
};
```

### Основные компоненты

#### 1. CombatCalculator (Chunk Server)
Выполняет расчеты урона и боевой механики:
- Расчет базового урона скилов
- Обработка критических ударов
- Система блокирования и промахов
- Применение защиты (физической/магической)

#### 2. SkillManager (Chunk Server)
Управляет использованием скилов:
- Проверка доступности скилов (кулдауны, мана)
- ИИ для выбора лучших скилов мобов
- Система кулдаунов
- Интеграция с CombatCalculator

#### 3. CharacterManager (Обновленный)
Загружает и управляет данными персонажей:
- Загрузка скилов из базы данных
- Синхронизация с chunk-сервером
- Поддержка новой системы атрибутов

#### 4. MobManager (Обновленный)
Управляет мобами со скилами:
- Загрузка скилов мобов
- Интеграция с ИИ боевой системы

## База данных

### Основные таблицы

#### skills
Основная таблица скилов с ссылками на школы и типы масштабирования.

#### skill_effects_mapping
Связывает эффекты скилов с их значениями по уровням.

#### skill_properties_mapping
Хранит свойства скилов (кулдауны, стоимость маны и т.д.).

#### entity_attributes
Новая унифицированная система атрибутов для персонажей и мобов.

#### character_skills_new / mob_skills_new
Связывают персонажей/мобов с их скилами.

## Формулы урона

### Базовый урон
```
BaseDamage = FlatAdd + (ScaleStatValue * Coefficient)
```

### Критический удар
```
CriticalDamage = BaseDamage * CritMultiplier
```

### Защита
```
DamageReduction = Defense / (Defense + 100)
FinalDamage = ScaledDamage * (1 - DamageReduction)
```

## Интеграция с существующей системой

### Game Server
- Загружает данные скилов и атрибутов из БД
- Передает данные в chunk-сервер при подключении персонажа
- Синхронизирует изменения

### Chunk Server
- Выполняет всю боевую логику
- Использует SkillManager для ИИ мобов
- Обрабатывает использование скилов игроками
- Применяет урон и эффекты

## Пример использования

### Использование скила персонажем
```json
{
    "eventType": "skillUsage",
    "data": {
        "skillSlug": "fireball",
        "targetId": 123
    }
}
```

### ИИ моба
```cpp
// Автоматически выбирает лучший скил для ситуации
const SkillStruct* bestSkill = skillManager->getBestSkillForMob(
    mobData, targetData, distance);
    
if (bestSkill && skillManager->isSkillAvailable(mobId, *bestSkill, mobData)) {
    auto result = skillManager->useMobSkill(mobId, bestSkill->skillSlug, targetId);
}
```

## Примеры атрибутов

### Боевые атрибуты
- `max_health` - Максимальное здоровье
- `max_mana` - Максимальная мана  
- `physical_attack` - Физическая атака
- `magical_attack` - Магическая атака
- `physical_defense` - Физическая защита
- `magical_defense` - Магическая защита
- `crit_chance` - Шанс критического удара (%)
- `crit_multiplier` - Множитель критического урона
- `accuracy` - Точность
- `evasion` - Уклонение
- `block_chance` - Шанс блокирования (%)
- `block_value` - Значение блокирования

### Утилитарные атрибуты
- `hp_regen_per_s` - Регенерация здоровья в секунду
- `mp_regen_per_s` - Регенерация маны в секунду
- `move_speed` - Скорость передвижения
- `attack_speed` - Скорость атаки
- `cast_speed` - Скорость каста

## Примеры скилов

### Basic Attack
- Школа: Physical
- Масштабирование: physical_attack
- Коэффициент: 1.0
- Кулдаун: 100ms
- Дальность: 2.5

### Fireball
- Школа: Fire  
- Масштабирование: magical_attack
- Коэффициент: 2.0
- Плоская добавка: 50
- Кулдаун: 3000ms
- Стоимость маны: 30
- Время каста: 2500ms
- Дальность: 8.0

### Power Slash
- Школа: Physical
- Масштабирование: physical_attack  
- Коэффициент: 1.8
- Плоская добавка: 30
- Кулдаун: 6000ms
- Стоимость маны: 20
- Время каста: 2000ms
- Дальность: 2.5

## Расширение системы

### Добавление новых скилов
1. Добавить запись в таблицу `skills`
2. Создать эффекты в `skill_effect_instances` и `skill_effects_mapping`  
3. Добавить свойства в `skill_properties_mapping`
4. Связать с персонажами/мобами через `character_skills_new`/`mob_skills_new`

### Добавление новых атрибутов
1. Добавить в таблицу `entity_attributes`
2. Обновить логику расчетов в `CombatCalculator`
3. При необходимости обновить ИИ в `SkillManager`

## Возможные улучшения

1. **Система эффектов во времени (DoT/HoT)**
   - Урон/лечение со временем
   - Баффы и дебаффы с длительностью

2. **Комбо системы**
   - Цепочки скилов с бонусами
   - Требования к предыдущим скилам

3. **Элементальные взаимодействия**
   - Сильные/слабые стороны школ магии
   - Синергия между разными типами урона

4. **Система талантов**
   - Улучшение скилов через таланты
   - Альтернативные пути развития

5. **Заряжаемые скилы**
   - Скилы с переменной силой в зависимости от времени заряда
   - Прерывание заряда при получении урона
